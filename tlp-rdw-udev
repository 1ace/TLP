#!/bin/sh
# tlp-rdw-udev - handle dock/undock events
#
# Copyright (c) 2012 Thomas Koch <linrunner at gmx.net>
# This software is licensed under the GPL v2.

# --- Definitions
LIB=/usr/lib/tlp-pm/tlp-functions
RFLIB=/usr/lib/tlp-pm/tlp-rf-func

# --- Source libraries
[ -f $LIB ] || exit 0
. $LIB

[ -f $RFLIB ] || exit 0
. $RFLIB

# --- MAIN
read_defaults
check_tlp_enabled || exit 1
[ -n "$DEVICES_TO_ENABLE_ON_UNDOCK" ] || exit 0

# Wait a moment for new power state to propagate
sleep 2.0

# Check dock state
ddir=/sys/devices/platform/$1
type=$(cat $ddir/type)
docked=$(cat $ddir/docked)
get_power_state; bat=$?

echo_debug "udev" "rdw_udev($*): dev=$ddir type=$type docked=$docked bat=$bat"

if [ "$bat" = "1" ]; then 
    # device is a docking station and laptop was undocked = on bat power
    echo_debug "udev" "tlp-rdw-udev.dock_event_on_bat_power"

    # enable radios
    for dev in $DEVICES_TO_ENABLE_ON_UNDOCK; do 
        [ -n "$dev" ] && device_on $dev
    done
fi

exit 0
