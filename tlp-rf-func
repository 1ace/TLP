#!/bin/sh
# tlp - rf switch functions

# ----------------------------------------------------------------------------
# Definitions
RFKILL="/sbin/rfkill"
RMMOD="/sbin/rmmod"

# ----------------------------------------------------------------------------
# Functions
get_ctrl_device () {
	local i
	
	case $1 in
		wwan|bluetooth)
			for i in /sys/devices/platform/thinkpad_acpi/rfkill/rfkill* ; do
				if [ "$(cat $i/type)" = "$1" ]; then 
					devc="$i/state"
					return
				fi
			done
			devc=""
			;;

		wifi)
			for i in /sys/class/rfkill/rfkill* ; do
				if [ "$(cat $i/type)" = "wlan" ]; then 
					devc="$i/state"
					return
				fi
			done
			devc=""
			;;
        
        *)
			echo "Error: no such device \"$1\"" 1>&2
			devc=""
			;;
	esac
}

check2200 () {
	local i
	
	is2200="0"
	if [ $1 = "wifi" ]; then
		devc=""
		if [ -d /sys/bus/pci/drivers/ipw2200 ]; then
			for i in /sys/bus/pci/drivers/ipw2200/*/rf_kill ; do
				devc=$i
			done
			[ -n "$devc" ] && is2200="1"
		fi
	fi
}

err_no_root_priv () {
	echo "Error: root privilege needed. Please call me with sudo." 1>&2
}

device_on () { 
	check2200 $1
	if [ "$is2200" = "1" ]; then
		if [ "$(id -u)" = "0" ]; then
			echo 0 > $devc
		else
			err_no_root_priv
		fi
	elif [ -x $RFKILL ]; then
		$RFKILL unblock $1
	else
		if [ "$(id -u)" = "0" ]; then
			get_ctrl_device $1
			if [ -n $devc ]; then
				echo -n 1 > $devc
			fi
		else
			err_no_root_priv
		fi
	fi
}

device_off () {
	check2200 $1
	if [ "$is2200" = "1" ]; then
		if [ "$(id -u)" = "0" ]; then
			echo 1 > $devc
		else
			err_no_root_priv
		fi
	elif [ -x $RFKILL ]; then
		$RFKILL block $1
	else
		if [ "$(id -u)" = "0" ]; then
			get_ctrl_device $1
			if [ -n $devc ]; then
				echo -n 0 > $devc
			fi
		else
			err_no_root_priv
		fi
	fi
}

device_state () {
	check2200 $1
	if [ "$is2200" = "1" ]; then
		if [ -z $devc ]; then
			state=254
		else
			state=$(cat $devc)
			state=$((! $state))
		fi
	else 
		get_ctrl_device $1
		if [ -z $devc ]; then
			state=254
		else
			state=$(cat $devc)
		fi
	fi
	
	case $1 in
		bluetooth)
			devstr="bluetooth"
			;;
			
		wifi)
			devstr="wifi     "
			;;
		
		wwan)
			devstr="wwan     "
			;;
			
		*)
			devstr=$1
			;;
	esac
	
	case $state in
		0) 
			echo "$devstr = off (software)"
			;;

		1) 
			echo "$devstr = on"
			;;
            
		2) 
			echo "$devstr = off (hardware)"
			;;
			
		254) 
			echo "$devstr = none (no device)"
			;;

		*)
            echo "$devstr = unknown state \"$state\""
	esac
}

